const t=document.getElementById("myCanvas"),n=t.getContext("2d"),x=document.getElementById("excelInput"),k=document.getElementById("generateAllButton"),R=document.getElementById("printAllButton"),O=document.getElementById("outputContainer"),g=new Image;let B=null,c={x:t.width/2,y:t.height/2},w="Name",v="Position",I="Company Name",E="Email",p=!1,f=[],m={x:t.width/2,y:t.height/2};g.src="/image/canvas/Canvas3.svg";g.onload=function(){n.clearRect(0,0,t.width,t.height),n.drawImage(g,0,0,t.width,t.height),A(),L(w,v,I,E)};t.addEventListener("mousedown",function(e){const a=t.getBoundingClientRect(),s=e.clientX-a.left,o=e.clientY-a.top;P(s,o)&&(p=!0)});t.addEventListener("mousemove",function(e){if(p){const a=t.getBoundingClientRect();c.x=e.clientX-a.left,c.y=e.clientY-a.top,b()}});t.addEventListener("mouseup",function(){p&&(m={...c},p=!1)});t.addEventListener("mouseleave",function(){p=!1});x.addEventListener("change",function(){if(x.files&&x.files[0]){const e=new FileReader;e.onload=function(a){const s=new Uint8Array(a.target.result),o=XLSX.read(s,{type:"array"}),i=o.Sheets[o.SheetNames[0]],d=XLSX.utils.sheet_to_json(i,{header:1}).slice(1).map(r=>({name:r[1],position:r[2],companyName:r[3],email:r[4]})).filter(r=>r.name&&r.position&&r.companyName&&r.email);d.length>0?(f=d,w="Name : "+f[0].name,v="Position : "+f[0].position,I="Company Name : "+f[0].companyName,E="Email : "+f[0].email,b(),k.style.display="block",R.style.display="block"):alert("No valid data found in the Excel file.")},e.readAsArrayBuffer(x.files[0])}});k.addEventListener("click",function(){$(f)});R.addEventListener("click",function(){D()});function P(e,a){n.font="20px Arial";const o=n.measureText(w).width,i=parseInt(n.font,10),l=c.x-o/2,d=c.y-i/2;return e>=l&&e<=l+o&&a>=d&&a<=d+i}function A(){n.strokeStyle="white",n.lineWidth=10,n.strokeRect(5,5,t.width-10,t.height-10)}function b(){n.clearRect(0,0,t.width,t.height),n.drawImage(g,0,0,t.width,t.height),A(),L(w,v,I,E)}function L(e,a,s,o){n.font="20px  Arial",n.fillStyle="black",n.textAlign="left",n.textBaseline="top",n.shadowColor="transparent",n.shadowBlur=0,n.shadowOffsetX=0,n.shadowOffsetY=0;const i=40;n.fillText(e,c.x,c.y-i),n.fillText(a,c.x,c.y),n.fillText(s,c.x,c.y+i),n.fillText(o,c.x,c.y+2*i)}function $(e){const a=document.querySelector(".User");a.innerHTML="",e.forEach(s=>{const o=document.createElement("div");o.classList.add("card");const i=document.createElement("canvas");i.width=t.width,i.height=t.height;const l=i.getContext("2d");l.drawImage(g,0,0,i.width,i.height),Y(l,s.name,s.position,s.companyName,s.email),B&&l.drawImage(B,0,0,360,500);const d=new Image;d.onload=function(){o.appendChild(d)},d.src=i.toDataURL(),d.className="output-image",a.appendChild(o)})}function Y(e,a,s,o,i){e.font="20px Arial",e.fillStyle="black",e.textAlign="left",e.textBaseline="top",e.shadowColor="transparent",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0;const l=40;e.fillText(`Name: ${a}`,m.x,m.y-l),e.fillText(`Position: ${s}`,m.x,m.y),e.fillText(`Company Name: ${o}`,m.x,m.y+l),e.fillText(`Email: ${i}`,m.x,m.y+2*l)}function D(){const e=new JSZip,a=[],s=document.querySelector(".progress-bar"),o=O.querySelectorAll(".output-image"),i=o.length;let l=0;function d(r,u){return new Promise((N,C)=>{const h=new Image;h.onload=function(){const y=document.createElement("canvas"),X=y.getContext("2d");y.width=h.width,y.height=h.height,X.drawImage(h,0,0),y.toBlob(S=>{if(!S){C(new Error("Canvas.toBlob returned null"));return}e.file(`card_${u+1}_${Date.now()}.png`,S),l++;const T=l/i*100;s.style.width=`${T}%`,s.textContent=`${Math.round(T)}%`,N()},"image/png")},h.onerror=function(){C(new Error("Image loading failed"))},h.src=r.src})}o.forEach((r,u)=>{a.push(d(r,u))}),document.querySelector(".progress").style.display="block",Promise.all(a).then(()=>{setTimeout(()=>{e.generateAsync({type:"blob"}).then(r=>{const u=document.createElement("a");u.href=URL.createObjectURL(r),u.download="Ivitation_cards_3.zip",u.click(),document.querySelector(".progress").style.display="none"})},100)}).catch(r=>{console.error("Error processing images:",r)})}const U=document.getElementById("avatarInput");U.addEventListener("change",function(){const e=this.files[0];if(e){const a=new FileReader;a.onload=function(s){const o=new Image;o.onload=function(){n.clearRect(0,0,t.width,t.height),n.drawImage(g,0,0,t.width,t.height),A(),n.drawImage(o,10,10,350,480),L(w,v,I,E),B=o},o.src=s.target.result},a.readAsDataURL(e)}});
