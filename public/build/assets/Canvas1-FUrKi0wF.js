const t=document.getElementById("myCanvas"),n=t.getContext("2d"),w=document.getElementById("excelInput"),A=document.getElementById("generateAllButton"),S=document.getElementById("printAllButton"),X=document.getElementById("outputContainer"),g=new Image;let c={x:t.width/2,y:t.height/2},x="Name",C="Position",E="Company Name",v="Email",p=!1,h=[],u={x:t.width/2,y:t.height/2};g.src="/image/canvas/Canvas1.svg";g.onload=function(){n.clearRect(0,0,t.width,t.height),n.drawImage(g,0,0,t.width,t.height),T(),b(x,C,E,v)};t.addEventListener("mousedown",function(e){const o=t.getBoundingClientRect(),l=e.clientX-o.left,i=e.clientY-o.top;_(l,i)&&(p=!0)});t.addEventListener("mousemove",function(e){if(p){const o=t.getBoundingClientRect();c.x=e.clientX-o.left,c.y=e.clientY-o.top,L()}});t.addEventListener("mouseup",function(){p&&(u={...c},p=!1)});t.addEventListener("mouseleave",function(){p=!1});w.addEventListener("change",function(){if(w.files&&w.files[0]){const e=new FileReader;e.onload=function(o){const l=new Uint8Array(o.target.result),i=XLSX.read(l,{type:"array"}),a=i.Sheets[i.SheetNames[0]],d=XLSX.utils.sheet_to_json(a,{header:1}).slice(1).map(s=>({name:s[1],position:s[2],companyName:s[3],email:s[4]})).filter(s=>s.name&&s.position&&s.companyName&&s.email);d.length>0?(h=d,x=h[0].name,C=h[0].position,E=h[0].companyName,v=h[0].email,L(),A.style.display="block",S.style.display="block"):alert("No valid data found in the Excel file.")},e.readAsArrayBuffer(w.files[0])}});A.addEventListener("click",function(){O(h)});S.addEventListener("click",function(){q()});function _(e,o){n.font="30px Arial";const i=n.measureText(x).width,a=parseInt(n.font,10),r=c.x-i/2,d=c.y-a/2;return e>=r&&e<=r+i&&o>=d&&o<=d+a}function T(){n.strokeStyle="white",n.lineWidth=10,n.strokeRect(5,5,t.width-10,t.height-10)}function L(){n.clearRect(0,0,t.width,t.height),n.drawImage(g,0,0,t.width,t.height),T(),b(x,C,E,v)}function b(e,o,l,i){n.font="25px  Arial",n.fillStyle="black",n.textAlign="center",n.textBaseline="middle",n.shadowColor="transparent",n.shadowBlur=0,n.shadowOffsetX=0,n.shadowOffsetY=0;const a=40;n.fillText(e,c.x,c.y-a),n.fillText(o,c.x,c.y),n.fillText(l,c.x,c.y+a),n.fillText(i,c.x,c.y+2*a)}function O(e){const o=document.querySelector(".User");o.innerHTML="",e.forEach(l=>{const i=document.createElement("div");i.classList.add("card");const a=document.createElement("canvas");a.width=t.width,a.height=t.height;const r=a.getContext("2d");r.drawImage(g,0,0,a.width,a.height),P(r,l.name,l.position,l.companyName,l.email);const d=new Image;d.src=a.toDataURL(),d.className="output-image",i.appendChild(d),o.appendChild(i)})}function P(e,o,l,i,a){e.font="25px Arial",e.fillStyle="black",e.textAlign="center",e.textBaseline="middle",e.shadowColor="transparent",e.shadowBlur=0,e.shadowOffsetX=0,e.shadowOffsetY=0;const r=40;e.fillText(o,u.x,u.y-r),e.fillText(l,u.x,u.y),e.fillText(i,u.x,u.y+r),e.fillText(a,u.x,u.y+2*r)}function q(){const e=new JSZip,o=[],l=document.querySelector(".progress-bar"),i=X.querySelectorAll(".output-image"),a=i.length;let r=0;function d(s,m){return new Promise((N,I)=>{const f=new Image;f.onload=function(){const y=document.createElement("canvas"),R=y.getContext("2d");y.width=f.width,y.height=f.height,R.drawImage(f,0,0),y.toBlob(B=>{if(!B){I(new Error("Canvas.toBlob returned null"));return}e.file(`card_${m+1}_${Date.now()}.png`,B),r++;const k=r/a*100;l.style.width=`${k}%`,l.textContent=`${Math.round(k)}%`,N()},"image/png")},f.onerror=function(){I(new Error("Image loading failed"))},f.src=s.src})}i.forEach((s,m)=>{o.push(d(s,m))}),document.querySelector(".progress").style.display="block",Promise.all(o).then(()=>{setTimeout(()=>{e.generateAsync({type:"blob"}).then(s=>{const m=document.createElement("a");m.href=URL.createObjectURL(s),m.download="list_of_thank_you_cards_2.zip",m.click(),document.querySelector(".progress").style.display="none"})},100)}).catch(s=>{console.error("Error processing images:",s)})}
